name: Minikube Pipeline

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Install Minikube
      run: |
        curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
        chmod +x minikube
        sudo mv minikube /usr/local/bin/

    - name: Install kubectl
      run: |
        curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/

    - name: Start Minikube
      run: |
        minikube start --apiserver-ips 0.0.0.0 --apiserver-name minikube-github-actions
      env:
        KUBECONFIG: ${{ runner.workspace }}/.kube/config

    - name: Pull Docker image from DockerHub
      run: docker pull your-dockerhub-username/your-image-name:latest

    - name: Set Docker image tag
      run: |
        echo ::set-env name=IMAGE_TAG::your-dockerhub-username/your-image-name:latest

    - name: Deploy container to Minikube
      run: |
        kubectl run my-container --image=$IMAGE_TAG --port=8080
